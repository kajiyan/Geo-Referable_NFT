# Frontend Architecture Analysis

This document summarizes the frontend implementation analysis for GeoRelationalNFT (NOROSI).

## 1. signedMintWithChain Implementation

### Overview

The `signedMintWithChain` contract function is fully implemented in the frontend with EIP-712 signature support.

### File Structure

| Layer | File | Purpose |
|-------|------|---------|
| Hook | `src/hooks/useNorosi.ts:127-164` | Contract call wrapper |
| Business Logic | `src/hooks/useMintingLogic.ts:158-170` | Mint orchestration for `type === 'chain'` |
| API Endpoint | `src/app/api/signature/route.ts:303-343` | EIP-712 signature generation (`MintWithChain` type) |
| UI Component | `src/components/features/NorosiMintWithChain.tsx` | Chain mint form |
| Modal | `src/components/features/modals/ChainMintModal.tsx` | Modal wrapper |
| Tests | `src/hooks/__tests__/useNorosi.test.ts:244-354` | Unit tests |

### Data Flow

```
User Action
    ↓
NorosiMintWithChain.tsx (UI)
    ↓
/api/signature (POST) → EIP-712 MintWithChain signature generation
    ↓
useNorosi.signedMintWithChain() → Contract call
    ↓
GeoRelationalNFT.signedMintWithChain() (Solidity)
```

### Parameter Mapping

| Contract Argument | Frontend Source |
|-------------------|-----------------|
| `to` | `address` from wagmi `useAccount()` |
| `refAddresses[]` | `[NOROSI_ADDRESS]` |
| `refTokenIds[]` | `[BigInt(refTokenId)]` |
| `latitude/longitude` | Scaled by `PRECISION (1e6)` |
| `elevation` | Scaled by `ELEVATION_PRECISION (1e4)` |
| `colorIndex` | Computed by server from Weather API |
| `h3` | Computed and verified on both client and server |
| `signature` | EIP-712 signature generated by server |

---

## 2. Weather-Based Visibility Range

### Overview

The AR view dynamically adjusts the NFT visibility range based on current weather conditions.

### File Structure

| File | Purpose |
|------|---------|
| `src/components/features/NFTObjects.tsx:41-53` | Applies weather-based radius to NFT query |
| `src/config/gpsConfig.ts:54-68` | Weather → Visibility distance mapping |
| `src/lib/slices/weatherSlice.ts` | Redux state management for weather data |

### Weather Visibility Configuration

```typescript
// src/config/gpsConfig.ts:54-68
WEATHER_VISIBILITY_CONFIG = {
  0: 10000,  // Clear - 10km
  1: 8000,   // Partly Cloudy - 8km
  2: 6000,   // Cloudy - 6km
  3: 4000,   // Overcast - 4km
  4: 3000,   // Light Drizzle - 3km
  5: 2500,   // Light Rain - 2.5km
  6: 2000,   // Moderate Rain - 2km
  7: 1500,   // Rain - 1.5km
  8: 1200,   // Heavy Rain - 1.2km
  9: 1100,   // Thunder Rain - 1.1km
  10: 1000,  // Heavy Thunder - 1km (minimum)
  11: 1500,  // Snow - 1.5km
  12: 1000,  // Fog - 1km (minimum)
}
```

### Data Flow

```
Weather API → weatherSlice (Redux) → selectWeatherColorIndex
                                           ↓
                                   getWeatherVisibility(colorIndex)
                                           ↓
                                   visibilityDistance (meters)
                                           ↓
                              useNearbyNFTs({ radiusMeters: visibilityDistance })
                                           ↓
                              NFTObjects → NFTObject → Norosi
```

### Key Implementation (NFTObjects.tsx)

```typescript
// Lines 41-53
const weatherColorIndex = useSelector(selectWeatherColorIndex)

const visibilityDistance = useMemo(
  () => getWeatherVisibility(weatherColorIndex),
  [weatherColorIndex]
)

const { nfts } = useNearbyNFTs({
  radiusMeters: visibilityDistance,
  maxCount: 50,
})
```

---

## 3. Elevation Data Handling

### Overview

Elevation data from the subgraph is reflected in the 3D positioning of Norosi smoke effects.

### File Structure

| File | Purpose |
|------|---------|
| `src/hooks/useNearbyNFTs.ts:73-76` | Elevation unit conversion |
| `src/components/features/NFTObject.tsx:75-79` | Passes elevation to LocationObject |
| `src/components/features/LocationObject.tsx:33` | Applies elevation as Y-coordinate |

### Data Flow

```
Subgraph (elevation: ten-thousandths, e.g., 500000 = 50m)
          ↓
useNearbyNFTs.ts:245 → elevationToMeters() (÷ 10,000)
          ↓
NearbyNFT.elevation (meters)
          ↓
NFTObject.tsx:78 → <LocationObject elevation={nft.elevation} />
          ↓
LocationObject.tsx:33 → position = [x, elevation, z]
          ↓
3D Y-axis coordinate
```

### Conversion Function

```typescript
// src/hooks/useNearbyNFTs.ts:73-76
function elevationToMeters(elevation: string | number): number {
  const value = typeof elevation === 'string' ? parseFloat(elevation) : elevation
  return value / 10_000
}
```

### 3D Positioning

```typescript
// src/components/features/LocationObject.tsx:33
return [x, elevation, z] as [number, number, number]
//         ↑ Y-axis (vertical) reflects elevation
```

---

## 4. Norosi Component Architecture

### Overview

`Norosi.tsx` is a pure 3D rendering component for smoke effects. It does NOT contain weather or elevation logic directly.

### Key Props

```typescript
interface NorosiProps {
  position?: [number, number, number]
  rotation?: [number, number, number]
  scale?: number | [number, number, number]
  enableFrustumCulling?: boolean
  maxRenderDistance?: number
  tokenId?: string
  smokeProps?: {
    width?: number
    height?: number
    topColor?: string
    bottomColor?: string
    opacity?: number
    // ... animation parameters
  }
  textMarqueeProps?: {
    text?: string
    // ... marquee settings
  }
}
```

### Rendering Pipeline

1. **Parent Components** (NFTObjects → NFTObject → LocationObject) handle:
   - Weather-based filtering
   - GPS coordinate transformation
   - Elevation positioning

2. **Norosi Component** handles:
   - WebGL shader rendering
   - Frustum culling
   - LOD (Level of Detail)
   - Billboard rotation
   - Text marquee animation

### Component Hierarchy

```
NFTObjects.tsx (weather filtering, radius query)
    ↓
NFTObject.tsx (color mapping, smoke height calculation)
    ↓
LocationObject.tsx (GPS→3D coordinate conversion, elevation)
    ↓
Norosi.tsx (pure 3D smoke rendering)
```

---

## Summary

| Feature | Location | Notes |
|---------|----------|-------|
| Chain Mint | `useNorosi.ts`, `route.ts` | Full EIP-712 implementation |
| Weather Visibility | `NFTObjects.tsx`, `gpsConfig.ts` | 1-10km range based on colorIndex |
| Elevation | `useNearbyNFTs.ts`, `LocationObject.tsx` | Y-axis positioning in meters |
| 3D Rendering | `Norosi.tsx` | Pure rendering, no business logic |
